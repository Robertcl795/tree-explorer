<div class="tree-main-container" [attr.aria-label]="treeConfig().ariaLabel">
  @if (isLoading()) {
    <mat-progress-bar mode="indeterminate" class="main-loading-bar"></mat-progress-bar>
  }

  @if (rootLoadError()) {
    <div class="empty-state error">
      <mat-icon>error</mat-icon>
      <span>{{ rootLoadError()!.message || 'Failed to load tree data' }}</span>
    </div>
  } @else if (isLoading() && visibleRows().length === 0) {
    <div class="empty-state loading">
      <mat-progress-spinner
        diameter="40"
        mode="indeterminate"></mat-progress-spinner>
      <span>Loading tree data...</span>
    </div>
  } @else {
    @if (pinnedSectionVisible()) {
      <div class="pinned-section">
        <div
          class="pinned-branch"
          role="button"
          tabindex="0"
          [style.min-height.px]="itemSize()"
          [attr.aria-expanded]="!pinnedCollapsed()"
          (click)="togglePinnedCollapsed()"
          (keydown.enter)="togglePinnedCollapsed($event)"
          (keydown.space)="togglePinnedCollapsed($event)">
          <button
            type="button"
            class="pinned-branch-caret"
            mat-icon-button
            tabindex="-1"
            [attr.aria-label]="pinnedCollapsed() ? 'Expand pinned section' : 'Collapse pinned section'"
            (click)="togglePinnedCollapsed($event)">
            <mat-icon>{{ pinnedCollapsed() ? 'chevron_right' : 'expand_more' }}</mat-icon>
          </button>
          <mat-icon class="pinned-branch-icon">star</mat-icon>
          <span class="pinned-branch-label">{{ pinnedConfig().label }}</span>
        </div>

        @if (!pinnedCollapsed()) {
          <div class="pinned-children" role="group">
            @if (pinnedLoading()) {
              <div class="pinned-state">Loading pinned items...</div>
            }
            @if (pinnedError()) {
              <div class="pinned-state error">Failed to sync pinned items</div>
            }

            <div
              class="pinned-list"
              cdkDropList
              [cdkDropListDisabled]="!pinnedDndEnabled()"
              (cdkDropListDropped)="onPinnedDrop($event)">
              @for (item of pinnedItems(); track item.entry.entryId) {
                <div
                  class="pinned-item"
                  cdkDrag
                  [style.min-height.px]="itemSize()"
                  [cdkDragDisabled]="!pinnedDndEnabled()">
                  <a
                    class="pinned-link"
                    href="#"
                    [class.missing]="item.missing"
                    [attr.aria-disabled]="item.missing ? true : null"
                    [title]="item.missing ? 'Original node is unavailable' : 'Navigate to original node'"
                    (click)="onPinnedClick($event, item)"
                    (contextmenu)="openPinnedContextMenu($event, item)">
                    <mat-icon class="pinned-link-icon">{{ item.icon || 'star' }}</mat-icon>
                    <span class="pinned-link-label">{{ item.label }}</span>
                  </a>

                  @if (hasPinnedContextActions(item)) {
                    <button
                      type="button"
                      class="pinned-context"
                      mat-icon-button
                      (click)="openPinnedContextMenu($event, item)">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                  }
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
    @if (visibleRows().length === 0) {
      <div class="empty-state">
        <mat-icon>folder_open</mat-icon>
        <span>No data available</span>
      </div>
    } @else {
      <cdk-virtual-scroll-viewport
        #viewport
        [itemSize]="itemSize()"
        [minBufferPx]="200"
        [maxBufferPx]="400"
        class="tree-viewport">
        <td-tree-item
          *cdkVirtualFor="let row of visibleRows(); trackBy: trackByRowId"
          [row]="row"
          [display]="displayConfig()"
          [itemSize]="itemSize()"
          [selectionMode]="treeConfig().selection?.mode"
          [showContextButton]="hasContextActions(row)"
          [dragDropEnabled]="treeConfig().dragDrop === true"
          [filterQuery]="filterQuery()"
          (rowClick)="onRowClick($event, row)"
          (rowDoubleClick)="onRowDoubleClick($event, row)"
          (toggleExpand)="onToggleExpand($event, row)"
          (toggleSelect)="onToggleSelect($event, row)"
          (contextMenuRequest)="openContextMenu($event, row)"
          (contextButtonRequest)="openContextMenu($event, row)"
          (dragStart)="onDragStart($event, row)"
          (dragOver)="onDragOver($event, row)"
          (drop)="onDrop($event, row)"
          (dragEnd)="onDragEnd($event, row)" />
      </cdk-virtual-scroll-viewport>
    }
  }

  <button
    type="button"
    class="context-menu-anchor"
    mat-icon-button
    [matMenuTriggerFor]="contextMenu"
    [style.left.px]="menuX()"
    [style.top.px]="menuY()">
  </button>
</div>

<mat-menu #contextMenu="matMenu" (closed)="onMenuClosed()">
  @for (action of getContextActions(); track action.id) {
    <button
      mat-menu-item
      [disabled]="isActionDisabled(action)"
      (click)="onContextAction(action)">
      @if (getActionIcon(action); as icon) {
        <mat-icon>{{ icon }}</mat-icon>
      }
      <span>{{ getActionLabel(action) }}</span>
    </button>
    @if (contextRow() && action.showDividerAfter?.(contextRow()!.data)) {
      <mat-divider></mat-divider>
    }
  }
</mat-menu>
